'''
This script is used to simulate low dose chest images during a experimental study.
Please contact the author if you have any questions.
'''

import numpy as np
from scipy import ndimage

def mask_data_V21(image,steps,reg_coef, correction):
        
        max_val = image.max()
        noise_map = np.zeros(image.shape)
    
        for step in range(0, steps):
            #Create mask within bounds (upper/lower)
            upper =(max_val/steps)*(step+1)
            lower =(max_val/steps)*(step)
                        
            temp_im = np.where(image <= lower, 0, image)
            temp_im = np.where(image > upper, 0, temp_im)
                        
            temp_im_nan = np.where(temp_im == 0, np.nan, temp_im)
            if np.isnan(temp_im_nan).all():
                mask_mean = np.zeros(image.shape)
            else:            
                mask_mean = np.nanmean(temp_im_nan)
                        
            #Generate noise
    
            temp_noise = reg_coef * mask_mean * np.random.random(image.shape) * correction
            temp_noise = np.where(temp_im == 0, 0, temp_noise)
                        
            noise_map = temp_noise+noise_map
            
        noise_map = (ndimage.gaussian_filter(noise_map, sigma = 1))
                
        image_noised = (image - noise_map)
        image_noised = (np.where(image_noised < 0, 0, image_noised))
        image_noised = match_histograms(image_noised, image)
        
        return image_noised
